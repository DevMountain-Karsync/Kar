angular.module('karSync', ['ui.router'])
.config(function($stateProvider, $urlRouterProvider){
  $stateProvider
    .state('index', {
      url: '/'
    })
    .state('dashboard', {
    templateUrl: './views/dashboard.html',
    url: '/dashboard/',
    controller: 'dashCtrl'
    })
    .state('dashboardDisplay', {
    templateUrl: './views/dashboardDisplay.html',
    url: '/display',
    parent: "dashboard",
    })
    .state('addCust', {
      templateUrl: './views/addCustomer.html',
      url: '/add/',
      controller: 'addCtrl'
    })
    .state('currentCust', {
      templateUrl: './views/currentCustomer.html',
      url: '/current/',
      controller: 'currentCtrl'
    })
    .state('login', {
      templateUrl: './views/login.html',
      url: '/login/',
      controller: 'loginCtrl'
    })
    .state('maintenance', {
      templateUrl: './views/maintenance.html',
      url: '/maintenance/',
      controller: 'maintCtrl'
    })
    .state('diagnostics', {
      templateUrl: './views/diagnostics.html',
      url: '/diagnostics/',
      controller: 'diagCtrl'
    })
    .state('schedule', {
      templateUrl: './views/schedule.html',
      url: '/schedule/',
      controller: 'scheduleCtrl'
    })
  $urlRouterProvider
  .otherwise('/')
});

angular.module('karSync')
.filter('searchUserList', function(){
 return function(arr, searchString2){
if(!searchString2){
    return arr;
};
var result = [];
searchString2 = searchString2.toLowerCase();
angular.forEach(arr, function(item){
  console.log(item)
    if(item.first_name.toLowerCase().indexOf(searchString2) !== -1){
    result.push(item);
}
    if(item.last_name.toLowerCase().indexOf(searchString2) !== -1) {
      result.push(item);
    }
});
return result;
};
});

angular.module('karSync')
.filter('searchFor', function(){
    return function(arr, searchString){
//make
        if(!searchString){
            return arr;
        }
        var result = [];
        searchString = searchString.toLowerCase();
        angular.forEach(arr, function(item){
            if(item.name.toLowerCase().indexOf(searchString) !== -1){
            // console.log(item)
            result.push(item);
        }
        });
        return result;
    };
//model
    return function(arr, searchString1){
    if(!searchString1){
        return arr;
    };
    var result = [];
    searchString1 = searchString1.toLowerCase();
    angular.forEach(arr, function(item){
        if(item.name.toLowerCase().indexOf(searchString1) !== -1){
        result.push(item);
    }
    });
    return result;
  };


//users
//   return function(arr, searchString2){
//   if(!searchString2){
//       return arr;
//   };
//   var result = [];
//   searchString2 = searchString2.toLowerCase();
//   angular.forEach(arr, function(item){
//     console.log(item)
//       if(item.name.toLowerCase().indexOf(searchString2) !== -1){
//       result.push(item);
//   }
// });
//   return result;
// };
});

angular.module('karSync')
.service('edmundService', function ($http){

//sending year I.D. to receive maintanence report. sets description of frequency field.
this.byYear = function(yId) {
      return $http.get('https://api.edmunds.com/v1/api/maintenance/actionrepository/findbymodelyearid?modelyearid='+yId+'&fmt=json&api_key=ph7zhymwvhhr28wfeqvdpcws').
        then(function(data) {
        

          for (var i = 0; i < data.data.actionHolder.length; i++) {
          var freq =  data.data.actionHolder[i].frequency;

          if(freq === 1){
            data.data.actionHolder[i].frequency = '1 = A-service schedule. This is the basic 1-year maintenance service that most cars get.'
          }
          if(freq === 2) {
            data.data.actionHolder[i].frequency = '2 - B-service schedule. This is the extended maintenance service that comes after #1.'
          }
          if(freq === 3) {
            data.data.actionHolder[i].frequency = '3 - This maintenance service takes place once at the exact value of the Interval Mileage or Interval Month, whichever comes first.'
          }
          if(freq === 4) {
            data.data.actionHolder[i].frequency = '4 - This maintenance service takes place every Interval Mileage or Interval Month value, whichever comes first.'
          }
          if(freq === 5) {
            data.data.actionHolder[i].frequency = '5 - This maintenance service takes place more frequently.'
          }
          if(freq === 6) {
            data.data.actionHolder[i].frequency = '6 - This maintenance service takes place when the warning light indicates.'
          }
          if(freq === 7) {
            data.data.actionHolder[i].frequency = '7 - Inspection I as recommended by the vehicle manufacturer.'
          }
          if(freq === 8) {
            data.data.actionHolder[i].frequency = '8 - Inspection II as recommended by the vehicle manufacturer.'
          }
          if(freq === 9) {
            data.data.actionHolder[i].frequency = '9 - Second Inspection II.'
          }

          }
          return data;

        });

}
//select make of vehicle to send it to the getModel function/api call
this.getMake = function(){
  return $http.get('https://api.edmunds.com/api/vehicle/v2/makes?view=basic&fmt=json&api_key=ph7zhymwvhhr28wfeqvdpcws').
  success(function(data){
    return data;

  });
}
//select model to send the year ID to the maintanence report (byYear) function/api call
this.getModel = function(make) {
  return $http.get('https://api.edmunds.com/api/vehicle/v2/'+make+'/models?view=basic&fmt=json&api_key=ph7zhymwvhhr28wfeqvdpcws').
  success(function(data){
    return data;

  });
}
})

angular.module('karSync')
.service('userServ', function($http){

this.getUser = function(){
  return $http({
    method: 'GET',
    url: 'http://localhost:3000/api/customers/1'
  })
  .then(function(response){
    // console.log(response.data[1]);
    // console.log(response.data[1].first_name);
    return response.data;
  })
 }
});

angular.module('karSync')
.controller('addCtrl', function($scope){

});

angular.module('karSync')
.controller('currentCtrl', function($scope){

});

angular.module('karSync')
.controller('dashCtrl', function($scope, userServ){
  userServ.getUser().then(function(user){
    $scope.userList = user;
  })
});

angular.module('karSync')
.controller('diagCtrl', function($scope, edmundService){
  edmundService.getMake().then(function(res){

    $scope.makes = res.data.makes;
    // console.log(res.data.makes)
  })

  edmundService.getModel().then(function(res){
    $scope.models = res.data.models;
  })

 $scope.makeList = function(make){
  edmundService.getModel(make).then(function(res){
    $scope.models = res.data.models;
  })
  }
$scope.yearOption = function(model) {

  $scope.years = model.years;

  }
$scope.yearsModel = function(year) {

  for (var i = 0; i < $scope.years.length; i++) {
    if($scope.years[i].year === year){

      edmundService.byYear($scope.years[i].id).then(function(res){
        console.log(res);
        $scope.showAlert = false;

        $scope.maintArr = res.data.actionHolder;
          if(res.data.actionHolder.length === 0) {
            $scope.alert ='no maintanence schedule available';
            $scope.showAlert = true;
          }


      })
    }
  }

}

});

angular.module('karSync')
.controller('loginCtrl', function($scope){

});

angular.module('karSync')
.controller('maintCtrl', function($scope, edmundService){
  edmundService.getMake().then(function(res){
    $scope.makes = res.data.makes;
  })

  edmundService.getModel().then(function(res){
    $scope.models = res.data.models;
  })

 $scope.makeList = function(make){
  edmundService.getModel(make).then(function(res){
    $scope.models = res.data.models;
  })
  }
$scope.yearOption = function(model) {

  $scope.years = model.years;

  }
$scope.yearsModel = function(year) {

  for (var i = 0; i < $scope.years.length; i++) {
    if($scope.years[i].year === year){

      edmundService.byYear($scope.years[i].id).then(function(res){

        $scope.showAlert = false;

        $scope.maintArr = res.data.actionHolder;
          if(res.data.actionHolder.length === 0) {
            $scope.alert ='no maintanence schedule available';
            $scope.showAlert = true;
          }


      })
    }
  }

}

});

angular.module('karSync')
.controller('scheduleCtrl', function($scope){
});
